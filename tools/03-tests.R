source("tools/00-funs.R", echo = TRUE)

first_line <- "# Generated by 03-tests.R"

get_test_code <- function(name, code, is_tbl_return) {
  formals <- formals(code)

  two_tables <- (length(formals) > 1) && (names(formals)[[2]] == "y")

  if (is_tbl_return) {
    post_coerce <- " %>% as_duckplyr_df()"
  } else {
    post_coerce <- ""
  }

  test_code_pre <- c(
    first_line,
    'test_that("as_duckplyr_df() commutes for {{{name}}}()", {',
    "  # Data"
  )

  if (two_tables) {
    test_code <- c(
      "  test_df_x <- data.frame(a = 1, b = 2)",
      "  test_df_y <- data.frame(a = 1, b = 2)",
      "",
      "  # Run",
      "  pre <- test_df_x %>% as_duckplyr_df() %>% {{{name}}}(test_df_y)",
      "  post <- test_df_x %>% {{{name}}}(test_df_y){{{post_coerce}}}"
    )
  } else {
    test_code <- c(
      "  test_df <- data.frame(a = 1, b = 2)",
      "",
      "  # Run",
      "  pre <- test_df %>% as_duckplyr_df() %>% {{{name}}}()",
      "  post <- test_df %>% {{{name}}}(){{{post_coerce}}}"
    )
  }

  test_code_post <- c(
    "",
    "  # Compare",
    "  expect_equal(pre, post)",
    "})",
    ""
  )

  test_code <- whisker::whisker.render(c(test_code_pre, test_code, test_code_post))
}

old <-
  tibble(path = fs::dir_ls("tests/testthat", glob = "*.R")) %>%
  mutate(first_line = map_chr(path, brio::read_lines, 1)) %>%
  filter(first_line == !!first_line)

fs::file_delete(old$path)

tests <-
  df_methods %>%
  mutate(test_code = pmap(list(name, code, is_tbl_return), get_test_code))

tests %>%
  mutate(path = fs::path("tests", "testthat", paste0("test-", name, ".R"))) %>%
  select(text = test_code, path) %>%
  pwalk(brio::write_file)
