# Generated by 03-tests.R

withr::local_envvar(DUCKPLYR_FORCE = "TRUE")

test_that("as_duckplyr_df() commutes for add_count()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% add_count()
  post <- test_df %>% add_count() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for anti_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% anti_join(test_df_y)
  post <- test_df_x %>% anti_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for arrange()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% arrange()
  post <- test_df %>% arrange() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for auto_copy()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% auto_copy(test_df_y)
  post <- test_df_x %>% auto_copy(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for collapse()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% collapse()
  post <- test_df %>% collapse() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for collect()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% collect()
  post <- test_df %>% collect() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for compute()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% compute()
  post <- test_df %>% compute() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for count()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% count()
  post <- test_df %>% count() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for cross_join()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% cross_join(test_df_y)
  post <- test_df_x %>% cross_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for distinct()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct()
  post <- test_df %>% distinct() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for do(data.frame(c = 1))", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% do(data.frame(c = 1))
  post <- test_df %>% do(data.frame(c = 1))

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for dplyr_reconstruct(test_df)", {
  skip("Hack")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% dplyr_reconstruct(test_df)
  post <- test_df %>% dplyr_reconstruct(test_df)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for filter(a == 1)", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% filter(a == 1)
  post <- test_df %>% filter(a == 1) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for full_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% full_join(test_df_y)
  post <- test_df_x %>% full_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for group_vars()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% group_vars()
  post <- test_df %>% group_vars()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for inner_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% inner_join(test_df_y)
  post <- test_df_x %>% inner_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for intersect()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% intersect(test_df_y)
  post <- test_df_x %>% intersect(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for left_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% left_join(test_df_y)
  post <- test_df_x %>% left_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for mutate()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate()
  post <- test_df %>% mutate() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for nest_by()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("WAT")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% nest_by()
  post <- test_df %>% nest_by() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for nest_join()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% nest_join(test_df_y)
  post <- test_df_x %>% nest_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for pull()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% pull()
  post <- test_df %>% pull()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for reframe()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% reframe()
  post <- test_df %>% reframe()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for relocate()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% relocate()
  post <- test_df %>% relocate() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rename()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename()
  post <- test_df %>% rename() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})


test_that("as_duckplyr_df() commutes for rename(c = a)", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename(c = a)
  post <- test_df %>% rename(c = a) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rename_with(identity)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename_with(identity)
  post <- test_df %>% rename_with(identity) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for right_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% right_join(test_df_y)
  post <- test_df_x %>% right_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_append()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_append(test_df_y)
  post <- test_df_x %>% rows_append(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_delete()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_delete(test_df_y)
  post <- test_df_x %>% rows_delete(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_insert(, conflict = \"ignore\")", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_insert(test_df_y, conflict = "ignore")
  post <- test_df_x %>% rows_insert(test_df_y, conflict = "ignore") %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_patch()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_patch(test_df_y)
  post <- test_df_x %>% rows_patch(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_update()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_update(test_df_y)
  post <- test_df_x %>% rows_update(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for rows_upsert()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_upsert(test_df_y)
  post <- test_df_x %>% rows_upsert(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for sample_frac()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% sample_frac()
  post <- test_df %>% sample_frac() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for sample_n(size = 1)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% sample_n(size = 1)
  post <- test_df %>% sample_n(size = 1) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for select(a)", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% select(a)
  post <- test_df %>% select(a) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})


test_that("as_duckplyr_df() commutes for select(everything())", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% select(everything())
  post <- test_df %>% select(everything()) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for semi_join()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% semi_join(test_df_y)
  post <- test_df_x %>% semi_join(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for setdiff()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% setdiff(test_df_y)
  post <- test_df_x %>% setdiff(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for setequal()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% setequal(test_df_y)
  post <- test_df_x %>% setequal(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice()
  post <- test_df %>% slice() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice_head()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_head()
  post <- test_df %>% slice_head() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice_max(a)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_max(a)
  post <- test_df %>% slice_max(a) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice_min(a)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_min(a)
  post <- test_df %>% slice_min(a) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice_sample()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_sample()
  post <- test_df %>% slice_sample() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for slice_tail()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_tail()
  post <- test_df %>% slice_tail() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for summarise(c = mean(a))", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% summarise(c = mean(a))
  post <- test_df %>% summarise(c = mean(a)) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})


test_that("as_duckplyr_df() commutes for summarise(c = mean(a), .by = b)", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% summarise(c = mean(a), .by = b)
  post <- test_df %>% summarise(c = mean(a), .by = b) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for symdiff()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% symdiff(test_df_y)
  post <- test_df_x %>% symdiff(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for tally()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% tally()
  post <- test_df %>% tally() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for tbl_vars()", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% tbl_vars()
  post <- test_df %>% tbl_vars()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for transmute(c = a + 1)", {
  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% transmute(c = a + 1)
  post <- test_df %>% transmute(c = a + 1) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for ungroup()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("Grouped")

  # Data
  test_df <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% ungroup()
  post <- test_df %>% ungroup() %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for union()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% union(test_df_y)
  post <- test_df_x %>% union(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() commutes for union_all()", {
  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% union_all(test_df_y)
  post <- test_df_x %>% union_all(test_df_y) %>% as_duckplyr_df()

  # Compare
  expect_equal(pre, post)
})
