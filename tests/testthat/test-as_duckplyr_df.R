# Generated by 03-tests.R

withr::local_envvar(DUCKPLYR_FORCE = "TRUE")

meta <- testthat::is_parallel() # Slow!
# meta <- TRUE

test_that("as_duckplyr_df() and add_count()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% add_count() %>% as.data.frame()
  post <- test_df %>% add_count()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and anti_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% anti_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% anti_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and arrange()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% arrange() %>% as.data.frame()
  post <- test_df %>% arrange()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and auto_copy()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% auto_copy(test_df_y)
  post <- test_df_x %>% auto_copy(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and collapse()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% collapse() %>% as.data.frame()
  post <- test_df %>% collapse()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and collect()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% collect() %>% as.data.frame()
  post <- test_df %>% collect()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and compute()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% compute() %>% as.data.frame()
  post <- test_df %>% compute()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and count()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% count() %>% as.data.frame()
  post <- test_df %>% count()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and cross_join()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% cross_join(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% cross_join(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and distinct()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct() %>% as.data.frame()
  post <- test_df %>% distinct()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and distinct(a)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct(a) %>% as.data.frame()
  post <- test_df %>% distinct(a)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and distinct(a, b)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct(a, b) %>% as.data.frame()
  post <- test_df %>% distinct(a, b)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and distinct(b, b)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct(b, b) %>% as.data.frame()
  post <- test_df %>% distinct(b, b)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and union_all(data.frame(a = 1L, b = 3, g = 2L)) %>% distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% union_all(data.frame(a = 1L, b = 3, g = 2L)) %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% union_all(data.frame(a = 1L, b = 3, g = 2L)) %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and union_all(data.frame(a = 1L, b = 4, g = 2L)) %>% distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% union_all(data.frame(a = 1L, b = 4, g = 2L)) %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% union_all(data.frame(a = 1L, b = 4, g = 2L)) %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and union_all(data.frame(a = 1L, b = 5, g = 2L)) %>% distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% union_all(data.frame(a = 1L, b = 5, g = 2L)) %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% union_all(data.frame(a = 1L, b = 5, g = 2L)) %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and union_all(data.frame(a = 1L, b = 6, g = 2L)) %>% distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% union_all(data.frame(a = 1L, b = 6, g = 2L)) %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% union_all(data.frame(a = 1L, b = 6, g = 2L)) %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and union_all(data.frame(a = 1L, b = 7, g = 2L)) %>% distinct(g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% union_all(data.frame(a = 1L, b = 7, g = 2L)) %>% distinct(g) %>% as.data.frame()
  post <- test_df %>% union_all(data.frame(a = 1L, b = 7, g = 2L)) %>% distinct(g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and distinct(g, .keep_all = TRUE)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% distinct(g, .keep_all = TRUE) %>% as.data.frame()
  post <- test_df %>% distinct(g, .keep_all = TRUE)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and do(data.frame(c = 1))", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% do(data.frame(c = 1))
  post <- test_df %>% do(data.frame(c = 1))

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and dplyr_reconstruct(test_df)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("Hack")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% dplyr_reconstruct(test_df)
  post <- test_df %>% dplyr_reconstruct(test_df)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and filter(a == 1)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% filter(a == 1) %>% as.data.frame()
  post <- test_df %>% filter(a == 1)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and full_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% full_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% full_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and group_vars()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% group_vars()
  post <- test_df %>% group_vars()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and inner_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% inner_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% inner_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and intersect()", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% intersect(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% intersect(test_df_y)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and left_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% left_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% left_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and mutate()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate() %>% as.data.frame()
  post <- test_df %>% mutate()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(a + 1)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(a + 1) %>% as.data.frame()
  post <- test_df %>% mutate(a + 1)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(a + 1, .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(a + 1, .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(a + 1, .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(c = a + 1)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(c = a + 1) %>% as.data.frame()
  post <- test_df %>% mutate(c = a + 1)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(`if` = a + 1)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(`if` = a + 1) %>% as.data.frame()
  post <- test_df %>% mutate(`if` = a + 1)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(sum(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(sum(a)) %>% as.data.frame()
  post <- test_df %>% mutate(sum(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(sum(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(sum(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(sum(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(mean(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(mean(a)) %>% as.data.frame()
  post <- test_df %>% mutate(mean(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(mean(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(mean(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(mean(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(sd(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(sd(a)) %>% as.data.frame()
  post <- test_df %>% mutate(sd(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(sd(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(sd(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(sd(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a)) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a)) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, 2))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, 2)) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, 2))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, 2), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, 2), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, 2), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, 2))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, 2)) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, 2))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, 2), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, 2), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, 2), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, 4))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, 4)) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, 4))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, 4), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, 4), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, 4), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, 4))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, 4)) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, 4))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, 4), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, 4), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, 4), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, default = 0))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, default = 0)) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, default = 0))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lag(a, default = 0), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lag(a, default = 0), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lag(a, default = 0), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, default = 1000))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, default = 1000)) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, default = 1000))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(lead(a, default = 1000), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(lead(a, default = 1000), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(lead(a, default = 1000), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(min(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(min(a)) %>% as.data.frame()
  post <- test_df %>% mutate(min(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(min(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(min(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(min(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(max(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(max(a)) %>% as.data.frame()
  post <- test_df %>% mutate(max(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(max(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(max(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(max(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(first(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(first(a)) %>% as.data.frame()
  post <- test_df %>% mutate(first(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(first(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(first(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(first(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(last(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(last(a)) %>% as.data.frame()
  post <- test_df %>% mutate(last(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(last(a), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(last(a), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(last(a), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(nth(a, 2))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(nth(a, 2)) %>% as.data.frame()
  post <- test_df %>% mutate(nth(a, 2))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and mutate(nth(a, 2), .by = g)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% mutate(nth(a, 2), .by = g) %>% as.data.frame()
  post <- test_df %>% mutate(nth(a, 2), .by = g)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and nest_by()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("WAT")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% nest_by() %>% as.data.frame()
  post <- test_df %>% nest_by()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and nest_join(join_by(a))", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% nest_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% nest_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and pull()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% pull()
  post <- test_df %>% pull()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and reframe()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% reframe()
  post <- test_df %>% reframe()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and relocate()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% relocate() %>% as.data.frame()
  post <- test_df %>% relocate()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and rename()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename() %>% as.data.frame()
  post <- test_df %>% rename()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and rename(c = a)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename(c = a) %>% as.data.frame()
  post <- test_df %>% rename(c = a)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and rename_with(identity)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% rename_with(identity) %>% as.data.frame()
  post <- test_df %>% rename_with(identity)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and right_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% right_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% right_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and rows_append()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_append(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% rows_append(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and rows_delete(by = c(\"a\", \"b\"))", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_delete(test_df_y, by = c("a", "b")) %>% as.data.frame()
  post <- test_df_x %>% rows_delete(test_df_y, by = c("a", "b"))

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and rows_insert(by = \"a\", conflict = \"ignore\")", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_insert(test_df_y, by = "a", conflict = "ignore") %>% as.data.frame()
  post <- test_df_x %>% rows_insert(test_df_y, by = "a", conflict = "ignore")

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and rows_patch(by = \"a\")", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_patch(test_df_y, by = "a") %>% as.data.frame()
  post <- test_df_x %>% rows_patch(test_df_y, by = "a")

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and rows_update(by = \"a\")", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_update(test_df_y, by = "a") %>% as.data.frame()
  post <- test_df_x %>% rows_update(test_df_y, by = "a")

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and rows_upsert(by = \"a\")", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% rows_upsert(test_df_y, by = "a") %>% as.data.frame()
  post <- test_df_x %>% rows_upsert(test_df_y, by = "a")

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and sample_frac()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("Random seed")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% sample_frac() %>% as.data.frame()
  post <- test_df %>% sample_frac()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and sample_n(size = 1)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("Random seed")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% sample_n(size = 1) %>% as.data.frame()
  post <- test_df %>% sample_n(size = 1)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and select(a)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% select(a) %>% as.data.frame()
  post <- test_df %>% select(a)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and select(everything())", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% select(everything()) %>% as.data.frame()
  post <- test_df %>% select(everything())

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and semi_join(join_by(a))", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% semi_join(test_df_y, join_by(a)) %>% as.data.frame()
  post <- test_df_x %>% semi_join(test_df_y, join_by(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and setdiff()", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% setdiff(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% setdiff(test_df_y)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and setequal()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% setequal(test_df_y)
  post <- test_df_x %>% setequal(test_df_y)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice() %>% as.data.frame()
  post <- test_df %>% slice()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice_head()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_head() %>% as.data.frame()
  post <- test_df %>% slice_head()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice_max(a)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_max(a) %>% as.data.frame()
  post <- test_df %>% slice_max(a)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice_min(a)", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_min(a) %>% as.data.frame()
  post <- test_df %>% slice_min(a)

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice_sample()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_sample() %>% as.data.frame()
  post <- test_df %>% slice_sample()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and slice_tail()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("External vector?")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% slice_tail() %>% as.data.frame()
  post <- test_df %>% slice_tail()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and summarise(c = mean(a))", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% summarise(c = mean(a)) %>% as.data.frame()
  post <- test_df %>% summarise(c = mean(a))

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})


test_that("as_duckplyr_df() and summarise(c = mean(a), .by = b)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% summarise(c = mean(a), .by = b) %>% as.data.frame()
  post <- test_df %>% summarise(c = mean(a), .by = b)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and symdiff()", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% symdiff(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% symdiff(test_df_y)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and tally()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% tally() %>% as.data.frame()
  post <- test_df %>% tally()

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and tbl_vars()", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% tbl_vars()
  post <- test_df %>% tbl_vars()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and transmute(c = a + 1)", {
  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% transmute(c = a + 1) %>% as.data.frame()
  post <- test_df %>% transmute(c = a + 1)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and ungroup()", {
  withr::local_envvar(DUCKPLYR_FORCE = "FALSE")
  skip("Grouped")

  meta_clear()

  # Data
  test_df <- data.frame(a = 1:6 + 0, b = 2, g = rep(1:3, 1:3))

  # Run
  pre <- test_df %>% as_duckplyr_df() %>% ungroup() %>% as.data.frame()
  post <- test_df %>% ungroup()

  # Compare
  expect_equal(pre, post)
})

test_that("as_duckplyr_df() and union()", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% union(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% union(test_df_y)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})

test_that("as_duckplyr_df() and union_all()", {
  meta_clear()

  # Data
  test_df_x <- data.frame(a = 1, b = 2)
  test_df_y <- data.frame(a = 1, b = 2)

  # Run
  pre <- test_df_x %>% as_duckplyr_df() %>% union_all(test_df_y) %>% as.data.frame()
  post <- test_df_x %>% union_all(test_df_y)

  # Compare
  expect_equal(pre, post)

  # Meta
  if (meta) {
    meta_fun <- meta_replay_to_fun()
    meta <- meta_fun(get_default_duckdb_connection(), (Sys.getenv("DUCKPLYR_EXPERIMENTAL") == "TRUE"))
    expect_equal(meta, post)
  }
})
