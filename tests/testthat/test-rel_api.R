# Generated by 05-duckdb-tests.R

test_that("relational anti_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_join(
    rel5,
    rel4,
    list(
      duckdb:::expr_function("___eq_na_matches_na", list(duckdb:::expr_reference("a", rel5), duckdb:::expr_reference("a", rel4)))
    ),
    "anti"
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number_x", rel5)))
  rel8 <- duckdb:::rel_project(
    rel7,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      }
    )
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(a = numeric(0), b = numeric(0))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational arrange()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel1
  out <- duckdb:::rel_to_altrep(rel1)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational count()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"n\"() AS (COUNT(*))"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_aggregate(
    rel1,
    groups = list(),
    aggregates = list({
      tmp_expr <- duckdb:::expr_function("n", list())
      duckdb:::expr_set_alias(tmp_expr, "n")
      tmp_expr
    })
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(n = 6L)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational distinct()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            a = {
              tmp_expr <- duckdb:::expr_reference("a")
              duckdb:::expr_set_alias(tmp_expr, "a")
              tmp_expr
            },
            b = {
              tmp_expr <- duckdb:::expr_reference("b")
              duckdb:::expr_set_alias(tmp_expr, "b")
              tmp_expr
            },
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational distinct(a)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            a = {
              tmp_expr <- duckdb:::expr_reference("a")
              duckdb:::expr_set_alias(tmp_expr, "a")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list({
      tmp_expr <- duckdb:::expr_reference("a")
      duckdb:::expr_set_alias(tmp_expr, "a")
      tmp_expr
    })
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational distinct(a, b)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            a = {
              tmp_expr <- duckdb:::expr_reference("a")
              duckdb:::expr_set_alias(tmp_expr, "a")
              tmp_expr
            },
            b = {
              tmp_expr <- duckdb:::expr_reference("b")
              duckdb:::expr_set_alias(tmp_expr, "b")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      }
    )
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational distinct(b, b)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            b = {
              tmp_expr <- duckdb:::expr_reference("b")
              duckdb:::expr_set_alias(tmp_expr, "b")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list({
      tmp_expr <- duckdb:::expr_reference("b")
      duckdb:::expr_set_alias(tmp_expr, "b")
      tmp_expr
    })
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(b = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational union_all(data.frame(a = 1L, b = 3, g = 2L)) %>% distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  df2 <- data.frame(a = 1L, b = 3, g = 2L)

  rel2 <- duckdb:::rel_from_df(con, df2, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_project(
    rel3,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_filter(
    rel5,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number")))
  rel8 <- duckdb:::rel_project(
    rel7,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational union_all(data.frame(a = 1L, b = 4, g = 2L)) %>% distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  df2 <- data.frame(a = 1L, b = 4, g = 2L)

  rel2 <- duckdb:::rel_from_df(con, df2, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_project(
    rel3,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_filter(
    rel5,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number")))
  rel8 <- duckdb:::rel_project(
    rel7,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational union_all(data.frame(a = 1L, b = 5, g = 2L)) %>% distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  df2 <- data.frame(a = 1L, b = 5, g = 2L)

  rel2 <- duckdb:::rel_from_df(con, df2, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_project(
    rel3,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_filter(
    rel5,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number")))
  rel8 <- duckdb:::rel_project(
    rel7,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational union_all(data.frame(a = 1L, b = 6, g = 2L)) %>% distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  df2 <- data.frame(a = 1L, b = 6, g = 2L)

  rel2 <- duckdb:::rel_from_df(con, df2, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_project(
    rel3,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_filter(
    rel5,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number")))
  rel8 <- duckdb:::rel_project(
    rel7,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational union_all(data.frame(a = 1L, b = 7, g = 2L)) %>% distinct(g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  df2 <- data.frame(a = 1L, b = 7, g = 2L)

  rel2 <- duckdb:::rel_from_df(con, df2, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_project(
    rel3,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_filter(
    rel5,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number")))
  rel8 <- duckdb:::rel_project(
    rel7,
    list({
      tmp_expr <- duckdb:::expr_reference("g")
      duckdb:::expr_set_alias(tmp_expr, "g")
      tmp_expr
    })
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational distinct(g, .keep_all = TRUE)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      duckdb:::expr_reference("___row_number"),
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("row_number", list()),
          list(
            g = {
              tmp_expr <- duckdb:::expr_reference("g")
              duckdb:::expr_set_alias(tmp_expr, "g")
              tmp_expr
            }
          ),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "___row_number_by")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_filter(
    rel3,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("___row_number_by"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          }
        )
      )
    )
  )
  rel5 <- duckdb:::rel_order(rel4, list(duckdb:::expr_reference("___row_number")))
  rel6 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel6
  out <- duckdb:::rel_to_altrep(rel6)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 4), b = c(2, 2, 2), g = 1:3)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational filter(a == 1)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"==\"(a, b) AS a = b"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_filter(
    rel1,
    list(
      duckdb:::expr_function(
        "==",
        list(
          duckdb:::expr_reference("a"),
          if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1, experimental = experimental)
          } else {
            duckdb:::expr_constant(1)
          }
        )
      )
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(a = 1, b = 2, g = 1L)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational full_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  invisible(DBI::dbExecute(con, "CREATE MACRO \"___coalesce\"(a, b) AS COALESCE(a, b)"))
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      }
    )
  )
  rel7 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel8 <- duckdb:::rel_project(
    rel6,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_y")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_y")
        tmp_expr
      }
    )
  )
  rel9 <- duckdb:::rel_join(
    rel7,
    rel8,
    list(
      duckdb:::expr_function(
        "___eq_na_matches_na",
        list(duckdb:::expr_reference("a_x", rel7), duckdb:::expr_reference("a_y", rel8))
      )
    ),
    "outer"
  )
  rel10 <- duckdb:::rel_order(
    rel9,
    list(duckdb:::expr_reference("___row_number_x", rel7), duckdb:::expr_reference("___row_number_y", rel8))
  )
  rel11 <- duckdb:::rel_project(
    rel10,
    list(
      {
        tmp_expr <- duckdb:::expr_function(
          "___coalesce",
          list(duckdb:::expr_reference("a_x", rel7), duckdb:::expr_reference("a_y", rel8))
        )
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b.x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b.y")
        tmp_expr
      }
    )
  )
  rel11
  out <- duckdb:::rel_to_altrep(rel11)
  expect_equal(
    out,
    data.frame(a = 1, b.x = 2, b.y = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational inner_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      }
    )
  )
  rel7 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel8 <- duckdb:::rel_project(
    rel6,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_y")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_y")
        tmp_expr
      }
    )
  )
  rel9 <- duckdb:::rel_join(
    rel7,
    rel8,
    list(
      duckdb:::expr_function(
        "___eq_na_matches_na",
        list(duckdb:::expr_reference("a_x", rel7), duckdb:::expr_reference("a_y", rel8))
      )
    ),
    "inner"
  )
  rel10 <- duckdb:::rel_order(
    rel9,
    list(duckdb:::expr_reference("___row_number_x", rel7), duckdb:::expr_reference("___row_number_y", rel8))
  )
  rel11 <- duckdb:::rel_project(
    rel10,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b.x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b.y")
        tmp_expr
      }
    )
  )
  rel11
  out <- duckdb:::rel_to_altrep(rel11)
  expect_equal(
    out,
    data.frame(a = 1, b.x = 2, b.y = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational intersect()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel3 <- duckdb:::rel_set_intersect(rel1, rel2)
  rel3
  out <- duckdb:::rel_to_altrep(rel3)
  expect_equal(
    out,
    data.frame(a = 1, b = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational left_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      }
    )
  )
  rel7 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel8 <- duckdb:::rel_project(
    rel6,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_y")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_y")
        tmp_expr
      }
    )
  )
  rel9 <- duckdb:::rel_join(
    rel7,
    rel8,
    list(
      duckdb:::expr_function(
        "___eq_na_matches_na",
        list(duckdb:::expr_reference("a_x", rel7), duckdb:::expr_reference("a_y", rel8))
      )
    ),
    "left"
  )
  rel10 <- duckdb:::rel_order(
    rel9,
    list(duckdb:::expr_reference("___row_number_x", rel7), duckdb:::expr_reference("___row_number_y", rel8))
  )
  rel11 <- duckdb:::rel_project(
    rel10,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b.x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b.y")
        tmp_expr
      }
    )
  )
  rel11
  out <- duckdb:::rel_to_altrep(rel11)
  expect_equal(
    out,
    data.frame(a = 1, b.x = 2, b.y = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational mutate()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel1
  out <- duckdb:::rel_to_altrep(rel1)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(a + 1)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_function(
          "+",
          list(
            duckdb:::expr_reference("a"),
            if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
              duckdb:::expr_constant(1, experimental = experimental)
            } else {
              duckdb:::expr_constant(1)
            }
          )
        )
        duckdb:::expr_set_alias(tmp_expr, "a + 1")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `a + 1` = c(2, 3, 4, 5, 6, 7),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(a + 1, .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_function(
          "+",
          list(
            duckdb:::expr_reference("a"),
            if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
              duckdb:::expr_constant(1, experimental = experimental)
            } else {
              duckdb:::expr_constant(1)
            }
          )
        )
        duckdb:::expr_set_alias(tmp_expr, "a + 1")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("a + 1")
        duckdb:::expr_set_alias(tmp_expr, "a + 1")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `a + 1` = c(2, 3, 4, 5, 6, 7),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(c = a + 1)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_function(
          "+",
          list(
            duckdb:::expr_reference("a"),
            if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
              duckdb:::expr_constant(1, experimental = experimental)
            } else {
              duckdb:::expr_constant(1)
            }
          )
        )
        duckdb:::expr_set_alias(tmp_expr, "c")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      c = c(2, 3, 4, 5, 6, 7)
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(`if` = a + 1)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_function(
          "+",
          list(
            duckdb:::expr_reference("a"),
            if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
              duckdb:::expr_constant(1, experimental = experimental)
            } else {
              duckdb:::expr_constant(1)
            }
          )
        )
        duckdb:::expr_set_alias(tmp_expr, "if")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `if` = c(2, 3, 4, 5, 6, 7),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(sum(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("sum", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "sum(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `sum(a)` = c(21, 21, 21, 21, 21, 21),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(sum(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("sum", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "sum(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("sum(a)")
        duckdb:::expr_set_alias(tmp_expr, "sum(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `sum(a)` = c(1, 5, 5, 15, 15, 15),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(mean(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("mean", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "mean(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `mean(a)` = c(3.5, 3.5, 3.5, 3.5, 3.5, 3.5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(mean(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("mean", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "mean(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("mean(a)")
        duckdb:::expr_set_alias(tmp_expr, "mean(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `mean(a)` = c(1, 2.5, 2.5, 5, 5, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(sd(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("stddev", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "sd(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `sd(a)` = c(
        0x1.deeea11683f49p+0, 0x1.deeea11683f49p+0, 0x1.deeea11683f49p+0,
        0x1.deeea11683f49p+0, 0x1.deeea11683f49p+0, 0x1.deeea11683f49p+0
      ),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(sd(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("stddev", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "sd(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("sd(a)")
        duckdb:::expr_set_alias(tmp_expr, "sd(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `sd(a)` = c(NA, 0.7071067811865475727373, 0.7071067811865475727373, 1, 1, 1),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a)` = c(NA, 1, 2, 3, 4, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lag(a)")
        duckdb:::expr_set_alias(tmp_expr, "lag(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a)` = c(NA, NA, 2, NA, 4, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a)` = c(2, 3, 4, 5, 6, NA),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lead(a)")
        duckdb:::expr_set_alias(tmp_expr, "lead(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a)` = c(NA, 3, NA, 5, 6, NA),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, 2))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(2, experimental = experimental)
          } else {
            duckdb:::expr_constant(2)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 2)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, 2)` = c(NA, NA, 1, 2, 3, 4),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, 2), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(2, experimental = experimental)
          } else {
            duckdb:::expr_constant(2)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 2)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lag(a, 2)")
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 2)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, 2)` = c(NA, NA, NA, NA, NA, 4),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, 2))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(2, experimental = experimental)
          } else {
            duckdb:::expr_constant(2)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 2)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, 2)` = c(3, 4, 5, 6, NA, NA),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, 2), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(2, experimental = experimental)
          } else {
            duckdb:::expr_constant(2)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 2)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lead(a, 2)")
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 2)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, 2)` = c(NA, NA, NA, 6, NA, NA),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, 4))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(4, experimental = experimental)
          } else {
            duckdb:::expr_constant(4)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 4)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, 4)` = c(NA, NA, NA, NA, 1, 2),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, 4), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(4, experimental = experimental)
          } else {
            duckdb:::expr_constant(4)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 4)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lag(a, 4)")
        duckdb:::expr_set_alias(tmp_expr, "lag(a, 4)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, 4)` = c(NA_real_, NA_real_, NA_real_, NA_real_, NA_real_, NA_real_),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, 4))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(4, experimental = experimental)
          } else {
            duckdb:::expr_constant(4)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 4)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, 4)` = c(5, 6, NA, NA, NA, NA),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, 4), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(4, experimental = experimental)
          } else {
            duckdb:::expr_constant(4)
          },
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 4)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lead(a, 4)")
        duckdb:::expr_set_alias(tmp_expr, "lead(a, 4)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, 4)` = c(NA_real_, NA_real_, NA_real_, NA_real_, NA_real_, NA_real_),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, default = 0))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(0, experimental = experimental)
          } else {
            duckdb:::expr_constant(0)
          }
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, default = 0)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, default = 0)` = c(0, 1, 2, 3, 4, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lag(a, default = 0), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lag", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(0, experimental = experimental)
          } else {
            duckdb:::expr_constant(0)
          }
        )
        duckdb:::expr_set_alias(tmp_expr, "lag(a, default = 0)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lag(a, default = 0)")
        duckdb:::expr_set_alias(tmp_expr, "lag(a, default = 0)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lag(a, default = 0)` = c(0, 0, 2, 0, 4, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, default = 1000))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1000, experimental = experimental)
          } else {
            duckdb:::expr_constant(1000)
          }
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, default = 1000)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, default = 1000)` = c(2, 3, 4, 5, 6, 1000),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(lead(a, default = 1000), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function("lead", list(x = duckdb:::expr_reference("a"))),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1L, experimental = experimental)
          } else {
            duckdb:::expr_constant(1L)
          },
          default_expr = if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
            duckdb:::expr_constant(1000, experimental = experimental)
          } else {
            duckdb:::expr_constant(1000)
          }
        )
        duckdb:::expr_set_alias(tmp_expr, "lead(a, default = 1000)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("lead(a, default = 1000)")
        duckdb:::expr_set_alias(tmp_expr, "lead(a, default = 1000)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `lead(a, default = 1000)` = c(1000, 3, 1000, 5, 6, 1000),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(min(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("min", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "min(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `min(a)` = c(1, 1, 1, 1, 1, 1),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(min(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("min", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "min(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("min(a)")
        duckdb:::expr_set_alias(tmp_expr, "min(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `min(a)` = c(1, 2, 2, 4, 4, 4),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(max(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("max", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "max(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `max(a)` = c(6, 6, 6, 6, 6, 6),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(max(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("max", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "max(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("max(a)")
        duckdb:::expr_set_alias(tmp_expr, "max(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `max(a)` = c(1, 3, 3, 6, 6, 6),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(first(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("first_value", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "first(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `first(a)` = c(1, 1, 1, 1, 1, 1),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(first(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("first_value", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "first(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("first(a)")
        duckdb:::expr_set_alias(tmp_expr, "first(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `first(a)` = c(1, 2, 2, 4, 4, 4),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(last(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("last_value", list(duckdb:::expr_reference("a"))), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "last(a)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `last(a)` = c(6, 6, 6, 6, 6, 6),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(last(a), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("last_value", list(duckdb:::expr_reference("a"))), list(duckdb:::expr_reference("g")), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "last(a)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("last(a)")
        duckdb:::expr_set_alias(tmp_expr, "last(a)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `last(a)` = c(1, 3, 3, 6, 6, 6),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(nth(a, 2))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function(
            "nth_value",
            list(
              duckdb:::expr_reference("a"),
              if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
                duckdb:::expr_constant(2, experimental = experimental)
              } else {
                duckdb:::expr_constant(2)
              }
            )
          ),
          list(),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "nth(a, 2)")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `nth(a, 2)` = c(2, 2, 2, 2, 2, 2),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational mutate(nth(a, 2), .by = g)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      }
    )
  )
  rel3 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("___row_number")
        duckdb:::expr_set_alias(tmp_expr, "___row_number")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(
          duckdb:::expr_function(
            "nth_value",
            list(
              duckdb:::expr_reference("a"),
              if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
                duckdb:::expr_constant(2, experimental = experimental)
              } else {
                duckdb:::expr_constant(2)
              }
            )
          ),
          list(duckdb:::expr_reference("g")),
          list(),
          offset_expr = NULL,
          default_expr = NULL
        )
        duckdb:::expr_set_alias(tmp_expr, "nth(a, 2)")
        tmp_expr
      }
    )
  )
  rel4 <- duckdb:::rel_order(rel3, list(duckdb:::expr_reference("___row_number")))
  rel5 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("nth(a, 2)")
        duckdb:::expr_set_alias(tmp_expr, "nth(a, 2)")
        tmp_expr
      }
    )
  )
  rel5
  out <- duckdb:::rel_to_altrep(rel5)
  expect_equal(
    out,
    data.frame(
      a = c(1, 2, 3, 4, 5, 6),
      b = c(2, 2, 2, 2, 2, 2),
      g = c(1L, 2L, 2L, 3L, 3L, 3L),
      `nth(a, 2)` = c(NA, 3, 3, 5, 5, 5),
      check.names = FALSE
    )
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational relocate()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational rename()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational rename(c = a)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "c")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(c = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational right_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_project(
    rel4,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      }
    )
  )
  rel7 <- duckdb:::rel_project(
    rel5,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_x")
        duckdb:::expr_set_alias(tmp_expr, "a_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b_x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel8 <- duckdb:::rel_project(
    rel6,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_y")
        duckdb:::expr_set_alias(tmp_expr, "a_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b_y")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_y")
        tmp_expr
      }
    )
  )
  rel9 <- duckdb:::rel_join(
    rel7,
    rel8,
    list(
      duckdb:::expr_function(
        "___eq_na_matches_na",
        list(duckdb:::expr_reference("a_x", rel7), duckdb:::expr_reference("a_y", rel8))
      )
    ),
    "right"
  )
  rel10 <- duckdb:::rel_order(
    rel9,
    list(duckdb:::expr_reference("___row_number_x", rel7), duckdb:::expr_reference("___row_number_y", rel8))
  )
  rel11 <- duckdb:::rel_project(
    rel10,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a_y", rel8)
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_x")
        duckdb:::expr_set_alias(tmp_expr, "b.x")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b_y")
        duckdb:::expr_set_alias(tmp_expr, "b.y")
        tmp_expr
      }
    )
  )
  rel11
  out <- duckdb:::rel_to_altrep(rel11)
  expect_equal(
    out,
    data.frame(a = 1, b.x = 2, b.y = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational select(a)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list({
      tmp_expr <- duckdb:::expr_reference("a")
      duckdb:::expr_set_alias(tmp_expr, "a")
      tmp_expr
    })
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational select(everything())", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("g")
        duckdb:::expr_set_alias(tmp_expr, "g")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational semi_join(join_by(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(
    DBI::dbExecute(
      con,
      "CREATE MACRO \"___eq_na_matches_na\"(a, b) AS ((a IS NULL AND b IS NULL) OR (a = b))"
    )
  )
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_set_alias(rel1, "lhs")
  rel3 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel4 <- duckdb:::rel_set_alias(rel3, "rhs")
  rel5 <- duckdb:::rel_project(
    rel2,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_window(duckdb:::expr_function("row_number", list()), list(), list(), offset_expr = NULL, default_expr = NULL)
        duckdb:::expr_set_alias(tmp_expr, "___row_number_x")
        tmp_expr
      }
    )
  )
  rel6 <- duckdb:::rel_join(
    rel5,
    rel4,
    list(
      duckdb:::expr_function("___eq_na_matches_na", list(duckdb:::expr_reference("a", rel5), duckdb:::expr_reference("a", rel4)))
    ),
    "semi"
  )
  rel7 <- duckdb:::rel_order(rel6, list(duckdb:::expr_reference("___row_number_x", rel5)))
  rel8 <- duckdb:::rel_project(
    rel7,
    list(
      {
        tmp_expr <- duckdb:::expr_reference("a")
        duckdb:::expr_set_alias(tmp_expr, "a")
        tmp_expr
      },
      {
        tmp_expr <- duckdb:::expr_reference("b")
        duckdb:::expr_set_alias(tmp_expr, "b")
        tmp_expr
      }
    )
  )
  rel8
  out <- duckdb:::rel_to_altrep(rel8)
  expect_equal(
    out,
    data.frame(a = 1, b = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational setdiff()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel3 <- duckdb:::rel_set_diff(rel1, rel2)
  rel3
  out <- duckdb:::rel_to_altrep(rel3)
  expect_equal(
    out,
    data.frame(a = numeric(0), b = numeric(0))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational summarise(c = mean(a))", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_aggregate(
    rel1,
    groups = list(),
    aggregates = list({
      tmp_expr <- duckdb:::expr_function("mean", list(duckdb:::expr_reference("a")))
      duckdb:::expr_set_alias(tmp_expr, "c")
      tmp_expr
    })
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(c = 3.5)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})


test_that("relational summarise(c = mean(a), .by = b)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_aggregate(
    rel1,
    groups = list(duckdb:::expr_reference("b")),
    aggregates = list({
      tmp_expr <- duckdb:::expr_function("mean", list(duckdb:::expr_reference("a")))
      duckdb:::expr_set_alias(tmp_expr, "c")
      tmp_expr
    })
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(b = 2, c = 3.5)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational symdiff()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel3 <- duckdb:::rel_set_symdiff(rel1, rel2)
  rel3
  out <- duckdb:::rel_to_altrep(rel3)
  expect_equal(
    out,
    data.frame(a = numeric(0), b = numeric(0))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational tally()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  invisible(DBI::dbExecute(con, "CREATE MACRO \"n\"() AS (COUNT(*))"))
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_aggregate(
    rel1,
    groups = list(),
    aggregates = list({
      tmp_expr <- duckdb:::expr_function("n", list())
      duckdb:::expr_set_alias(tmp_expr, "n")
      tmp_expr
    })
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(n = 6L)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational transmute(c = a + 1)", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = c(1, 2, 3, 4, 5, 6), b = c(2, 2, 2, 2, 2, 2), g = c(1L, 2L, 2L, 3L, 3L, 3L))

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_project(
    rel1,
    list(
      c = {
        tmp_expr <- duckdb:::expr_function(
          "+",
          list(
            duckdb:::expr_reference("a"),
            if ("experimental" %in% names(formals(duckdb:::expr_constant))) {
              duckdb:::expr_constant(1, experimental = experimental)
            } else {
              duckdb:::expr_constant(1)
            }
          )
        )
        duckdb:::expr_set_alias(tmp_expr, "c")
        tmp_expr
      }
    )
  )
  rel2
  out <- duckdb:::rel_to_altrep(rel2)
  expect_equal(
    out,
    data.frame(c = c(2, 3, 4, 5, 6, 7))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational union()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel4 <- duckdb:::rel_distinct(rel3)
  rel4
  out <- duckdb:::rel_to_altrep(rel4)
  expect_equal(
    out,
    data.frame(a = 1, b = 2)
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})

test_that("relational union_all()", {
  # Autogenerated
  con <- DBI::dbConnect(duckdb::duckdb())
  experimental <- FALSE
  df1 <- data.frame(a = 1, b = 2)

  rel1 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel2 <- duckdb:::rel_from_df(con, df1, experimental = experimental)
  rel3 <- duckdb:::rel_union_all(rel1, rel2)
  rel3
  out <- duckdb:::rel_to_altrep(rel3)
  expect_equal(
    out,
    data.frame(a = c(1, 1), b = c(2, 2))
  )
  DBI::dbDisconnect(con, shutdown = TRUE)
})
